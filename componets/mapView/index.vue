<template>
  <view class="map-page">
    <!-- 地图控制按钮 -->
    <view class="map-controls">
      <view class="control-btn" @click="toggleSidebar">
        <text class="control-text">菜单</text>
      </view>
    </view>
    
    <!-- 地图容器 -->
    <view class="map-container">
      <map 
        id="locationMap"
        :latitude="mapCenter.latitude"
        :longitude="mapCenter.longitude"
        :scale="mapScale"
        :markers="mapMarkers"
        :show-location="true"
        :enable-3D="true"
        :enable-zoom="true"
        :enable-scroll="true"
        :enable-rotate="false"
        :enable-overlooking="false"
        :enable-satellite="enableSatellite"
        :enable-traffic="false"
        class="map-view"
        @markertap="onMarkerTap"
        @regionchange="onRegionChange"
      ></map>
    </view>

    <!-- 遮罩层 -->
    <view class="sidebar-mask" v-if="showSidebar" @click="hideSidebar"></view>

    <!-- 右侧抽屉 -->
    <view class="sidebar" :class="{ active: showSidebar }">
      <view class="sidebar-content">
        <scroll-view class="sidebar-body" scroll-y>
          <!-- 卫星地图切换 -->
          <view class="menu-section">
            <text class="menu-label">地图类型</text>
            <view class="menu-item" @click="toggleSatellite">
              <text class="menu-item-text">{{ enableSatellite ? '普通地图' : '卫星地图' }}</text>
              <view class="switch-wrapper">
                <switch :checked="enableSatellite" color="#1890ff" />
              </view>
            </view>
          </view>

          <!-- 位置类型选择 -->
          <view class="menu-section">
            <text class="menu-label">位置类型</text>
            <view class="menu-options">
              <view 
                v-for="(type, index) in locationTypeOptions" 
                :key="index"
                class="menu-option"
                :class="{ active: selectedType === type.value }"
                @click="selectLocationType(type.value)"
              >
                <view class="checkbox">
                  <view class="checkbox-inner" v-if="selectedType === type.value"></view>
                </view>
                <text class="option-label">{{ type.label }}</text>
              </view>
              <!-- 全部选项 -->
              <view 
                class="menu-option"
                :class="{ active: selectedType === null }"
                @click="selectLocationType(null)"
              >
                <view class="checkbox">
                  <view class="checkbox-inner" v-if="selectedType === null"></view>
                </view>
                <text class="option-label">全部</text>
              </view>
            </view>
          </view>

          <!-- 关键字选择（仅队站辖区显示） -->
          <view class="menu-section" v-if="selectedType === 3">
            <text class="menu-label">关键字</text>
            <view class="menu-options">
              <view 
                v-for="(keyword, index) in keywordOptions" 
                :key="index"
                class="menu-option"
                :class="{ active: selectedKeyword === keyword.value }"
                @click="selectKeyword(keyword.value)"
              >
                <view class="checkbox">
                  <view class="checkbox-inner" v-if="selectedKeyword === keyword.value"></view>
                </view>
                <text class="option-label">{{ keyword.label }}</text>
              </view>
            </view>
          </view>
        </scroll-view>
      </view>
    </view>
  </view>
</template>

<script>
import { locationTabList } from '@/commons/mock/index.js';

export default {
  props: {
    addressId: {
      type: [String, Number],
      default: null
    }
  },
  data() {
    return {
      serverUrl: 'https://www.xiaobei.space',
      mapCenter: {
        latitude: 39.9042, // 北京天安门坐标作为默认中心点
        longitude: 116.4074
      },
      mapScale: 16,
      mapMarkers: [],
      allLocations: [], // 所有地址数据
      filteredLocations: [], // 筛选后的地址数据
      currentLocation: null, // 目标地址详情
      userLocation: null, // 用户当前位置
      enableSatellite: false, // 是否启用卫星地图
      showSidebar: false, // 是否显示左侧抽屉
      locationTypeOptions: [], // 位置类型选项
      keywordOptions: [], // 关键字选项（队站辖区）
      selectedType: null, // 选中的位置类型
      selectedKeyword: null // 选中的关键字（队站辖区）
    };
  },
  mounted() {
    // 初始化位置类型选项
    this.locationTypeOptions = locationTabList.map(item => ({
      label: item.name,
      value: item.type
    }));
    this.loadAllLocations();
  },
  methods: {
    // 获取用户当前位置
    getUserLocation() {
      uni.getLocation({
        type: 'gcj02',
        success: (res) => {
          console.log('用户当前位置:', res);
          this.userLocation = {
            latitude: res.latitude,
            longitude: res.longitude,
            addressName: '我的位置',
            addressExt: '当前位置'
          };
          // 设置地图中心点为用户位置
          this.mapCenter = {
            latitude: res.latitude,
            longitude: res.longitude
          };
          this.updateMapMarkers();
        },
        fail: (err) => {
          console.error('获取用户位置失败:', err);
          uni.showToast({ title: '获取位置失败', icon: 'none' });
        }
      });
    },
    
    async loadAllLocations() {
      try {
        const res = await new Promise((resolve, reject) => {
          uni.request({
            url: this.serverUrl + '/location/list',
            method: 'GET',
            data: { page: 1, pageSize: 100 },
            success: resolve,
            fail: reject
          });
        });
        
        if (res.data && res.data.code === 200) {
          this.allLocations = res.data.data?.list || [];
          console.log('加载的位置数据:', this.allLocations);
          
          // 从列表中过滤出目标地址
          if (this.addressId) {
            this.currentLocation = this.allLocations.find(location => 
              location.addressId == this.addressId
            );
            console.log('目标地址:', this.currentLocation);
          }
          
          // 初始化为全部数据
          this.filteredLocations = [...this.allLocations];
          this.updateMapMarkers();
        } else {
          console.log('API返回错误:', res.data);
        }
      } catch (error) {
        console.error('加载位置列表失败:', error);
        uni.showToast({ title: '加载位置列表失败', icon: 'none' });
      }
    },
    
    
    updateMapMarkers() {
      this.mapMarkers = [];
      console.log('更新地图标记，位置数量:', this.allLocations.length);
      
      // 添加用户当前位置标记（蓝色）
      if (this.userLocation && this.userLocation.latitude && this.userLocation.longitude) {
        console.log('添加用户位置标记:', this.userLocation.addressName);
        this.mapMarkers.push({
          id: 'user', // 用户位置使用特殊id
          latitude: this.userLocation.latitude,
          longitude: this.userLocation.longitude,
          title: this.userLocation.addressName,
          // 用户位置使用蓝色标记
          width: 25,
          height: 25,
          callout: {
            content: `${this.userLocation.addressName}`,
            color: '#fff',
            fontSize: 12,
            fontWeight: 'bold',
            borderRadius: 6,
            bgColor: '#1890ff',
            padding: 6,
            display: 'ALWAYS',
            borderWidth: 2,
            borderColor: '#fff',
            textAlign: 'center'
          }
        });
      }
      
      // 显示筛选后的位置（包括目标地址和其他位置）
      this.filteredLocations.forEach((location, index) => {
        if (location.latitude && location.longitude) {
          // 判断是否是目标地址
          const isTarget = this.currentLocation && location.addressId == this.currentLocation.addressId;
          
          this.mapMarkers.push({
            id: isTarget ? 'target' : index, // 目标地址使用特殊id，其他使用索引
            latitude: location.latitude,
            longitude: location.longitude,
            title: location.addressName,
            width: isTarget ? 30 : 20, // 目标地址更大
            height: isTarget ? 30 : 20,
            callout: {
              content: `${location.addressName} | ${this.getLocationTypeName(location.type)}`,
              color: isTarget ? '#fff' : '#333', // 目标地址白色文字
              fontSize: isTarget ? 14 : 12,
              fontWeight: 'bold',
              borderRadius: isTarget ? 8 : 6,
              bgColor: isTarget ? '#ff4d4f' : '#fff', // 目标地址红色背景
              padding: isTarget ? 8 : 6,
              display: 'ALWAYS',
              borderWidth: isTarget ? 2 : 1,
              borderColor: isTarget ? '#fff' : '#ff4d4f',
              textAlign: 'center'
            }
          });
        }
      });
      
      // 设置地图中心点
      if (this.userLocation && this.userLocation.latitude && this.userLocation.longitude) {
        this.mapCenter = {
          latitude: this.userLocation.latitude,
          longitude: this.userLocation.longitude
        };
      } else if (this.currentLocation && this.currentLocation.latitude && this.currentLocation.longitude) {
        this.mapCenter = {
          latitude: this.currentLocation.latitude,
          longitude: this.currentLocation.longitude
        };
      }
      
      console.log('最终标记数量:', this.mapMarkers.length);
    },
    
    onMarkerTap(e) {
      const markerId = e.detail.markerId;
      
      if (markerId === 'user') {
        // 用户位置不跳转，只显示提示
        uni.showToast({ title: '我的位置', icon: 'none' });
      } else if (markerId === 'target') {
        // 点击目标地址，跳转到720全景
        this.goTo720View(this.currentLocation);
      } else if (typeof markerId === 'number' && this.filteredLocations[markerId]) {
        // 点击其他位置，跳转到720全景
        this.goTo720View(this.filteredLocations[markerId]);
      }
    },
    
    onRegionChange(e) {
      console.log('地图区域变化:', e);
    },
    
    
    // 跳转到720全景
    goTo720View(location) {
      if (!location) {
        uni.showToast({ title: '位置信息无效', icon: 'none' });
        return;
      }
      
      // 构建720全景URL
      const panoramaUrl = `${this.serverUrl}/720?lat=${location.latitude}&lng=${location.longitude}&name=${encodeURIComponent(location.addressName)}`;
      
      // 跳转到720全景页面
      uni.navigateTo({
        url: `/subPackages/common/webview/index?url=${encodeURIComponent(panoramaUrl)}&title=${encodeURIComponent(location.addressName + ' - 720全景')}`
      });
    },
    
    getLocationTypeName(type) {
      return locationTabList.find(item => item.type === type)?.name || '未知类型';
    },
    
    // 切换左侧抽屉
    toggleSidebar() {
      this.showSidebar = !this.showSidebar;
    },

    // 显示左侧抽屉
    showSidebarMenu() {
      this.showSidebar = true;
    },

    // 隐藏左侧抽屉
    hideSidebar() {
      this.showSidebar = false;
    },

    // 切换卫星地图
    toggleSatellite() {
      this.enableSatellite = !this.enableSatellite;
      
      uni.showToast({ 
        title: this.enableSatellite ? '已切换到卫星地图' : '已切换到普通地图', 
        icon: 'none',
        duration: 1500
      });
    },

    // 选择位置类型（立即触发筛选）
    selectLocationType(type) {
      this.selectedType = type;
      // 如果选择队站辖区，初始化关键字选项
      if (type === 3) {
        const district = locationTabList.find(item => item.type === 3);
        this.keywordOptions = district && Array.isArray(district.keywordOptions) 
          ? district.keywordOptions 
          : [{ label: '全部', value: 'all' }, { label: '森林', value: 'forest' }];
        // 默认选择第一个关键字
        if (!this.selectedKeyword) {
          this.selectedKeyword = this.keywordOptions[0]?.value || 'all';
        }
      } else {
        // 非队站辖区，清空关键字
        this.selectedKeyword = null;
        this.keywordOptions = [];
      }
      // 立即触发筛选
      this.applyFilter();
    },

    // 选择关键字（队站辖区，立即触发筛选）
    selectKeyword(keyword) {
      this.selectedKeyword = keyword;
      // 立即触发筛选
      this.applyFilter();
    },

    // 应用筛选
    applyFilter() {
      // 根据筛选条件过滤地址
      this.filteredLocations = this.allLocations.filter(location => {
        // 如果选择了位置类型，进行类型过滤
        if (this.selectedType !== null) {
          if (this.selectedType !== 3) {
            return location.type === this.selectedType;
          } else {
            return location.keywordType === this.selectedKeyword;
          }
        }
      });
      this.updateMapMarkers();
    }
  }
};
</script>

<style scoped>
.map-page {
  height: 100vh;
  display: flex;
  flex-direction: column;
  background-color: #f5f5f5;
}

.map-controls {
  position: absolute;
  top: 40rpx;
  left: 20rpx;
  z-index: 1000;
}

.control-btn {
  background: linear-gradient(135deg, #4a90e2 0%, #5ba0f2 100%);
  border-radius: 25rpx;
  padding: 20rpx 40rpx;
  box-shadow: 0 6rpx 16rpx rgba(74, 144, 226, 0.2);
  backdrop-filter: blur(10rpx);
  border: 1rpx solid rgba(255, 255, 255, 0.3);
}

.control-text {
  font-size: 30rpx;
  font-weight: 700;
  color: #fff;
  text-shadow: 0 1rpx 3rpx rgba(0, 0, 0, 0.15);
}

.map-container {
  flex: 1;
  position: relative;
  overflow: hidden;
}

.map-view {
  width: 100%;
  height: 100%;
}

/* 遮罩层 */
.sidebar-mask {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
  z-index: 1999;
  animation: fadeIn 0.3s ease;
}

/* 右侧抽屉 */
.sidebar {
  position: fixed;
  top: 0;
  right: 0;
  width: 70%;
  max-width: 600rpx;
  height: 100%;
  background: #ffffff;
  z-index: 2000;
  transform: translateX(100%);
  transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: -4rpx 0 16rpx rgba(0, 0, 0, 0.1);
}

.sidebar.active {
  transform: translateX(0);
}

.sidebar-content {
  display: flex;
  flex-direction: column;
  height: 100%;
}

.sidebar-body {
  flex: 1;
  overflow-y: auto;
  padding: 32rpx 32rpx;
}

.menu-section {
  margin-bottom: 40rpx;
}

.menu-label {
  display: block;
  font-size: 28rpx;
  font-weight: 600;
  color: #333;
  margin-bottom: 20rpx;
  padding-left: 8rpx;
}

.menu-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 24rpx;
  background: #f8f9fa;
  border-radius: 12rpx;
  margin-bottom: 12rpx;
  transition: all 0.3s ease;
}

.menu-item:active {
  background: #e9ecef;
}

.menu-item-text {
  font-size: 28rpx;
  color: #333;
  font-weight: 500;
}

.switch-wrapper {
  transform: scale(0.9);
}

.menu-options {
  display: flex;
  flex-direction: column;
  gap: 12rpx;
}

.menu-option {
  display: flex;
  align-items: center;
  padding: 20rpx;
  border: 2rpx solid #e1e8ed;
  border-radius: 12rpx;
  background: #ffffff;
  transition: all 0.3s ease;
}

.menu-option.active {
  border-color: #1890ff;
  background: linear-gradient(135deg, rgba(24, 144, 255, 0.08) 0%, rgba(24, 144, 255, 0.03) 100%);
}

.checkbox {
  width: 32rpx;
  height: 32rpx;
  border: 2rpx solid #cbd5e0;
  border-radius: 6rpx;
  margin-right: 16rpx;
  display: flex;
  justify-content: center;
  align-items: center;
  transition: all 0.3s ease;
  background: #ffffff;
  flex-shrink: 0;
}

.menu-option.active .checkbox {
  border-color: #1890ff;
  background: #1890ff;
}

.checkbox-inner {
  width: 20rpx;
  height: 20rpx;
  background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>');
  background-size: contain;
  background-repeat: no-repeat;
  background-position: center;
}

.option-label {
  font-size: 28rpx;
  color: #333;
  font-weight: 500;
  flex: 1;
}


@keyframes fadeIn {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}
</style>
